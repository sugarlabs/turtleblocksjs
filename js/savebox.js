// Copyright (c) 2014 Walter Bender
//
// This program is free software; you can redistribute it and/or modify
// it under the terms of the GNU General Public License as published by
// the Free Software Foundation; either version 3 of the License, or
// (at your option) any later version.
//
// You should have received a copy of the GNU General Public License
// along with this library; if not, write to the Free Software
// Foundation, 51 Franklin Street, Suite 500 Boston, MA 02110-1335 USA

var BUTTONBOX = '<svg xmlns="http://www.w3.org/2000/svg" width="180" height="180"> <rect width="180" height="180" x="0" y="40" style="fill:#ffffff;fill-opacity:1;fill-rule:nonzero;stroke:none" /> <g transform="translate(84.943,-0.053)" style="fill:#000000;display:block"> <path d="m 27.557,5.053 c -12.43,0 -22.5,10.076 -22.5,22.497 0,12.432 10.07,22.503 22.5,22.503 12.431,0 22.5,-10.071 22.5,-22.503 0,-12.421 -10.07,-22.497 -22.5,-22.497 z m 10.199,28.159 c 1.254,1.256 1.257,3.291 0,4.545 -0.628,0.629 -1.451,0.943 -2.274,0.943 -0.822,0 -1.644,-0.314 -2.27,-0.94 l -5.76,-5.761 -5.76,5.761 c -0.627,0.626 -1.449,0.94 -2.271,0.94 -0.823,0 -1.647,-0.314 -2.275,-0.943 -1.254,-1.254 -1.254,-3.289 0.004,-4.545 l 5.758,-5.758 -5.758,-5.758 c -1.258,-1.254 -1.258,-3.292 -0.004,-4.546 1.255,-1.254 3.292,-1.259 4.546,0 l 5.76,5.759 5.76,-5.759 c 1.252,-1.259 3.288,-1.254 4.544,0 1.257,1.254 1.254,3.292 0,4.546 l -5.758,5.758 5.758,5.758 z" style="fill:#000000;display:inline" /> </g> <rect width="174" height="120" x="3" y="57" style="fill:#96d3f3;fill-opacity:1;stroke:none" /> <g transform="translate(42,71.000008)" style="fill:none;stroke:#000000;stroke-opacity:1"> <path d="m 15.046106,34.391188 c -0.384814,0 -0.764757,-0.02436 -1.139133,-0.06959 l 0.965862,1.634591 0.951946,-1.60954 c -0.258167,0.02088 -0.515637,0.04454 -0.778675,0.04454 z" style="fill:none;stroke:#000000;stroke-width:2.08759975;stroke-miterlimit:4;stroke-opacity:1;stroke-dasharray:none" /> <g transform="matrix(0.69586655,0,0,0.69586655,-4.0881364,0.79544654)" style="fill:none;stroke:#000000;stroke-width:3;stroke-miterlimit:4;stroke-opacity:1;stroke-dasharray:none"> <path d="m 40.16,11.726 c -2.164,0 -3.958,1.555 -4.343,3.607 1.859,1.345 3.457,3.115 4.675,5.208 2.285,-0.172 4.094,-2.061 4.094,-4.39 0,-2.444 -1.982,-4.425 -4.426,-4.425 z" style="fill:none;stroke:#000000;stroke-width:3;stroke-miterlimit:4;stroke-opacity:1;stroke-dasharray:none" /> <path d="m 40.713,39.887 c -1.224,2.232 -2.86,4.131 -4.797,5.556 0.521,1.864 2.213,3.239 4.244,3.239 2.443,0 4.426,-1.98 4.426,-4.424 0,-2.255 -1.693,-4.096 -3.873,-4.371 z" style="fill:none;stroke:#000000;stroke-width:3;stroke-miterlimit:4;stroke-opacity:1;stroke-dasharray:none" /> <path d="m 14.273,39.871 c -2.253,0.206 -4.024,2.079 -4.024,4.387 0,2.443 1.98,4.424 4.424,4.424 2.064,0 3.784,-1.42 4.272,-3.332 -1.883,-1.416 -3.475,-3.289 -4.672,-5.479 z" style="fill:none;stroke:#000000;stroke-width:3;stroke-miterlimit:4;stroke-opacity:1;stroke-dasharray:none" /> <path d="m 19.026,15.437 c -0.343,-2.103 -2.154,-3.711 -4.353,-3.711 -2.444,0 -4.424,1.981 -4.424,4.424 0,2.382 1.886,4.31 4.245,4.406 1.186,-2.043 2.732,-3.784 4.532,-5.119 z" style="fill:none;stroke:#000000;stroke-width:3;stroke-miterlimit:4;stroke-opacity:1;stroke-dasharray:none" /> </g> <path d="m 15.046106,9.537618 c 1.327714,0 2.594191,0.2860012 3.770205,0.784937 0.515637,-0.7487519 0.819731,-1.6540743 0.819731,-2.6324627 0,-2.5656599 -2.079945,-4.6463009 -4.646301,-4.6463009 -2.56566,0 -4.645605,2.080641 -4.645605,4.6463009 0,0.9936975 0.314531,1.9129372 0.846174,2.6679527 1.199674,-0.5212044 2.496073,-0.820427 3.855796,-0.820427 z" style="fill:none;stroke:#000000;stroke-width:2.08759975;stroke-miterlimit:4;stroke-opacity:1;stroke-dasharray:none" /> <g transform="matrix(0.69586655,0,0,0.69586655,-4.0881364,0.79544654)" style="fill:none;stroke:#000000;stroke-width:3;stroke-miterlimit:4;stroke-opacity:1;stroke-dasharray:none"> <path d="m 43.102,30.421 c 0,4.7344 -1.6452,9.2798 -4.5706,12.6275 -2.9254,3.3478 -6.8973,5.2305 -11.0344,5.2305 -4.1371,0 -8.109,-1.8827 -11.0344,-5.2305 -2.9254,-3.3477 -4.5706,-7.8931 -4.5706,-12.6275 0,-9.7966 7.0444,-17.858 15.605,-17.858 8.5606,0 15.605,8.0614 15.605,17.858 z" style="fill:none;stroke:#000000;stroke-width:3;stroke-miterlimit:4;stroke-opacity:1;stroke-dasharray:none" /> </g> <g transform="matrix(0.69586655,0,0,0.69586655,-4.0881364,0.79544654)" style="fill:none;stroke:#000000;stroke-opacity:1"> <path d="m 25.875,33.75 -1.542,-4.625 3.164,-2.587 3.615,2.626 -1.487,4.669 -3.75,-0.083 z" style="fill:none;stroke:#000000;stroke-opacity:1" /> <path d="m 27.501,41.551 c -3.968,-0.16 -5.543,-2.009 -5.543,-2.009 l 3.57,-4.163 4.465,0.168 3.132,4.12 c 0,0 -2.89,1.994 -5.624,1.884 z" style="fill:none;stroke:#000000;stroke-opacity:1" /> <path d="m 18.453,33.843 c -0.849,-2.968 0.172,-6.884 0.172,-6.884 l 4,2.167 1.493,4.629 -3.582,4.233 c 0,-10e-4 -1.465,-1.99 -2.083,-4.145 z" style="fill:none;stroke:#000000;stroke-opacity:1" /> <path d="m 19.458,25.125 c 0,0 0.5,-1.958 3.039,-3.822 2.237,-1.643 4.465,-1.72 4.465,-1.72 l -0.037,4.981 -3.521,2.75 -3.946,-2.189 z" style="fill:none;stroke:#000000;stroke-opacity:1" /> <path d="M 32.084,27.834 28.625,24.959 29,19.75 c 0,0 1.834,-0.042 3.959,1.667 2.228,1.791 3.362,4.983 3.362,4.983 l -4.237,1.434 z" style="fill:none;stroke:#000000;stroke-opacity:1" /> <path d="m 31.292,34.042 1.313,-4.464 4.187,-1.536 c 0,0 0.677,2.663 -0.042,5.667 -0.54,2.256 -2.084,4.361 -2.084,4.361 l -3.374,-4.028 z" style="fill:none;stroke:#000000;stroke-opacity:1" /> </g> <g transform="matrix(1,0,0,-1,-30.386573,49.171266)" style="fill:none;stroke:#000000;stroke-opacity:1"> <g transform="translate(34.0803,-1006.42)" style="fill:none;stroke:#000000;stroke-opacity:1"> <polyline points="51.562,15.306 41.17,16.188 42.053,5.794" style="fill:none;stroke:#000000;stroke-width:3.5;stroke-linecap:round;stroke-linejoin:round;stroke-opacity:1" transform="matrix(-0.469241,0.469241,-0.469241,-0.469241,66.2906,1019.03)" /> <path d="m 39.363241,1033.1291 -0.05636,9.9115 -8.750608,0.067" style="fill:none;stroke:#000000;stroke-width:2.5;stroke-linecap:round;stroke-linejoin:round;stroke-miterlimit:4;stroke-opacity:1;stroke-dasharray:none" /> </g> </g> <g transform="translate(30.282289,-10.830115)" style="fill:none;stroke:#000000;stroke-opacity:1"> <circle cx="27.375" cy="27.5" r="19.903" transform="matrix(0.57728722,0,0,0.57728722,-4.585527,35.454716)" style="fill:none;stroke:#000000;stroke-width:3.5;stroke-opacity:1;display:inline" /> <g transform="matrix(0.57728722,0,0,0.57728722,-4.585527,35.454716)" style="fill:none;stroke:#000000;stroke-opacity:1;display:inline"> <path d="m 27.376,7.598 c 0,0 -11.205,8.394 -11.205,19.976 0,11.583 11.205,19.829 11.205,19.829" style="fill:none;stroke:#000000;stroke-width:3.5;stroke-opacity:1" /> <path d="m 27.376,7.598 c 0,0 11.066,9.141 11.066,19.976 0,10.839 -11.066,19.829 -11.066,19.829" style="fill:none;stroke:#000000;stroke-width:3.5;stroke-opacity:1" /> <line style="fill:none;stroke:#000000;stroke-width:3.5;stroke-opacity:1" x1="27.375999" x2="27.375999" y1="7.598" y2="47.402" /> <line style="fill:none;stroke:#000000;stroke-width:3.5;stroke-opacity:1" x1="27.375999" x2="27.375999" y1="7.598" y2="47.402" /> <line style="fill:none;stroke:#000000;stroke-width:3.5;stroke-opacity:1" x1="27.375999" x2="27.375999" y1="7.598" y2="47.402" /> <line style="fill:none;stroke:#000000;stroke-width:3.5;stroke-opacity:1" x1="7.4720001" x2="47.278" y1="27.5" y2="27.5" /> </g> </g> </g> </svg>'

// A pop up for saving projects
function SaveBox(canvas, stage, refreshCanvas, save) {
    this.canvas = canvas;
    this.stage = stage;
    this.refreshCanvas = refreshCanvas;
    this.doSave = save;
    this.container = null;
    this.save = null;
    this.close = null;
    this.scale = 1;

    this.hide = function() {
        if (this.container != null) {
            this.container.visible = false;
            this.refreshCanvas();
        }
	var saveName = docById('mySaveName');
	saveName.style.visibility = 'hidden';
    }

    this.show = function(scale) {
        this.scale = scale;
        if (this.container == null) {
            this.container = new createjs.Container();
            this.stage.addChild(this.container);
            this.container.x = Math.floor(((this.canvas.width / scale) - 140) / 2);
            this.container.y = 27;

            function processBackground(box, name, bitmap, extras) {
                box.container.addChild(bitmap);
		loadSaveContainerHandler(box);
		box.completeShow();
            }
            makeBoxBitmap(this, BUTTONBOX, 'box', processBackground, null);
        } else {
            this.completeShow();
        }
    }

    this.completeShow = function() {
	this.container.visible = true;
	this.refreshCanvas();
	var saveName = docById('mySaveName');
	saveName.style.visibility = 'visible';
        saveName.style.position = 'absolute';
	var left = this.canvas.offsetLeft + this.container.x + 64;
        saveName.style.left = left + 'px';
	var top = this.canvas.offsetTop + this.container.y + 160;
        saveName.style.top = top + 'px';
    }
}


function loadSaveContainerHandler(box) {
    var hitArea = new createjs.Shape();
    this.bounds = box.container.getBounds();
    hitArea.graphics.beginFill('#FFF').drawRect(bounds.x, bounds.y, bounds. width, bounds.height);
    hitArea.x = 0;
    hitArea.y = 0;
    box.container.hitArea = hitArea;

    var locked = false;
    box.container.on('click', function(event) {
        // We need a lock to "debouce" the click.
        if (locked) {
            console.log('debouncing click');
            return;
        }
        locked = true;
        setTimeout(function() {
            locked = false;
        }, 500);

        var x = (event.stageX / box.scale) - box.container.x;
        var y = (event.stageY / box.scale) - box.container.y;
        if (x > 85 && y < 55) {
            console.log('closing box');
            box.hide();
        } else if (y > 55) {
	    // Save
	    box.doSave();
	    box.hide();
        }
    });
}


function makeBoxBitmap(box, data, name, callback, extras) {
    // Async creation of bitmap from SVG data
    // Works with Chrome, Safari, Firefox (untested on IE)
    var img = new Image();
    img.onload = function() {
        bitmap = new createjs.Bitmap(img);
        callback(box, name, bitmap, extras);
    }
    img.src = 'data:image/svg+xml;base64,' + window.btoa(
        unescape(encodeURIComponent(data)));
}


function docById(id) {
    return document.getElementById(id);
}
